# Prometheus Metrics Example

This example demonstrates how to export Snowflake ID generator metrics to Prometheus for production monitoring and alerting.

## Features

- **Prometheus metrics endpoint** - Standard `/metrics` endpoint
- **Health checks** - `/health` endpoint with automatic issue detection
- **Example ID generation** - `/generate` endpoint showing real usage
- **Real-time metrics** - Background ID generation for live metrics
- **Docker Compose setup** - Complete monitoring stack (Prometheus + Grafana)

## Quick Start

### Run Standalone

```bash
# From the examples/prometheus directory
go run main.go

# Visit metrics endpoint
curl http://localhost:8080/metrics

# Generate an ID
curl http://localhost:8080/generate

# Check health
curl http://localhost:8080/health
```

### Run with Docker Compose (Prometheus + Grafana)

```bash
# Start the full monitoring stack
docker-compose up -d

# Access services:
# - Application:  http://localhost:8080
# - Prometheus:   http://localhost:9090
# - Grafana:      http://localhost:3000 (admin/admin)
```

## Exposed Metrics

All metrics include a `worker` label with the worker ID.

### Core Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `snowflake_ids_generated_total` | counter | Total number of IDs generated |
| `snowflake_clock_backward_total` | counter | Clock moved backward (recovered) |
| `snowflake_clock_backward_errors_total` | counter | Unrecoverable clock errors |
| `snowflake_sequence_overflow_total` | counter | Sequence exhaustion events |
| `snowflake_wait_time_microseconds_total` | counter | Total time spent waiting |
| `snowflake_avg_wait_microseconds` | gauge | Average wait time per ID |
| `snowflake_generator_info` | gauge | Generator information (static labels) |

## PromQL Queries

### Generation Rate

```promql
# IDs generated per second (last 1 minute)
rate(snowflake_ids_generated_total[1m])

# Total IDs per second across all workers
sum(rate(snowflake_ids_generated_total[1m]))

# IDs generated per worker
rate(snowflake_ids_generated_total[1m]) by (worker)
```

### Error Monitoring

```promql
# Clock backward error rate (errors/sec)
rate(snowflake_clock_backward_errors_total[5m])

# Total clock issues (backward events + errors)
sum(rate(snowflake_clock_backward_total[5m]) + rate(snowflake_clock_backward_errors_total[5m]))
```

### Performance Monitoring

```promql
# Average wait time per ID
snowflake_avg_wait_microseconds

# Sequence overflow rate (indicates high load)
rate(snowflake_sequence_overflow_total[1m])

# Total wait time per worker
rate(snowflake_wait_time_microseconds_total[1m])
```

## Alerting Rules

Add these to your Prometheus `rules.yml`:

```yaml
groups:
  - name: snowflake
    interval: 30s
    rules:
      # Alert on clock issues
      - alert: SnowflakeClockDrift
        expr: rate(snowflake_clock_backward_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Snowflake clock drift detected on worker {{ $labels.worker }}"
          description: "Clock backward errors: {{ $value | humanize }}/sec"

      # Alert on high sequence overflow
      - alert: SnowflakeHighLoad
        expr: rate(snowflake_sequence_overflow_total[1m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High load on Snowflake worker {{ $labels.worker }}"
          description: "Sequence overflows: {{ $value | humanize }}/sec. Consider adding more workers."

      # Alert on low throughput
      - alert: SnowflakeLowThroughput
        expr: rate(snowflake_ids_generated_total[5m]) < 10
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Low ID generation rate on worker {{ $labels.worker }}"
          description: "Generation rate: {{ $value | humanize }}/sec"
```

## Grafana Dashboard

### Quick Import

1. Open Grafana (http://localhost:3000)
2. Login with `admin/admin`
3. Go to Dashboards → Import
4. Upload `grafana-dashboard.json` (see below)

### Dashboard Panels

**1. Generation Rate**
```promql
sum(rate(snowflake_ids_generated_total[1m]))
```

**2. IDs Generated by Worker**
```promql
rate(snowflake_ids_generated_total[1m]) by (worker)
```

**3. Clock Issues**
```promql
sum(rate(snowflake_clock_backward_total[5m]))
sum(rate(snowflake_clock_backward_errors_total[5m]))
```

**4. Sequence Overflows**
```promql
rate(snowflake_sequence_overflow_total[1m]) by (worker)
```

**5. Average Wait Time**
```promql
snowflake_avg_wait_microseconds by (worker)
```

## Prometheus Scrape Configuration

Add to `prometheus.yml`:

```yaml
scrape_configs:
  - job_name: 'snowflake'
    scrape_interval: 15s
    static_configs:
      - targets: ['localhost:8080']
        labels:
          environment: 'production'
          service: 'id-generator'

    # For Kubernetes
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: snowflake
        action: keep
```

## Production Deployment

### Environment Variables

```bash
WORKER_ID=42        # Unique worker ID (0-1023)
PORT=8080           # HTTP server port
```

### Kubernetes Example

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: snowflake-generator
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: snowflake
        image: your-registry/snowflake-prometheus:latest
        env:
        - name: WORKER_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name  # Use pod name hash
        ports:
        - containerPort: 8080
          name: metrics
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: snowflake-metrics
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"
spec:
  selector:
    app: snowflake
  ports:
  - port: 8080
    name: metrics
```

## Monitoring Best Practices

### Key Metrics to Watch

1. **Generation Rate** - Should match expected load
2. **Clock Backward Errors** - Should be 0 (indicates NTP issues)
3. **Sequence Overflows** - High rate indicates need for more workers
4. **Average Wait Time** - Should be <100µs under normal conditions

### Alert Thresholds

- **Critical**: `clock_backward_errors > 0` for 2+ minutes
- **Warning**: `sequence_overflow > 10/sec` for 5+ minutes
- **Info**: Low throughput for 10+ minutes

### Grafana SLOs

```promql
# Availability (no clock errors)
(1 - (rate(snowflake_clock_backward_errors_total[1h]) / rate(snowflake_ids_generated_total[1h]))) * 100

# Error rate
(rate(snowflake_clock_backward_errors_total[5m]) / rate(snowflake_ids_generated_total[5m])) * 100
```

## Troubleshooting

### High Clock Backward Count

```bash
# Check NTP synchronization
ntpq -p

# Verify system clock
timedatectl status
```

**Solution:** Configure NTP properly or increase `MaxClockBackward` tolerance.

### High Sequence Overflow

**Cause:** Generating >4,096 IDs per millisecond per worker.

**Solutions:**
1. Add more workers (distribute load)
2. Use batch generation (`GenerateBatch`)
3. Choose layout with higher sequence bits

### Low Throughput

**Check:**
1. Is the application actually calling `GenerateID()`?
2. Are there errors in the logs?
3. Is context timeout too short?

## Example Output

### Metrics Endpoint (`/metrics`)

```
# HELP snowflake_ids_generated_total Total number of IDs generated
# TYPE snowflake_ids_generated_total counter
snowflake_ids_generated_total{worker="42"} 1523478

# HELP snowflake_clock_backward_total Number of times clock moved backward (recovered)
# TYPE snowflake_clock_backward_total counter
snowflake_clock_backward_total{worker="42"} 3

# HELP snowflake_sequence_overflow_total Number of sequence overflows
# TYPE snowflake_sequence_overflow_total counter
snowflake_sequence_overflow_total{worker="42"} 152

# HELP snowflake_avg_wait_microseconds Average wait time per ID
# TYPE snowflake_avg_wait_microseconds gauge
snowflake_avg_wait_microseconds{worker="42"} 2.35
```

### Health Endpoint (`/health`)

```
OK: Generated 1523478 IDs
```

## Next Steps

- **Add custom metrics** - Extend `PrometheusHandler()` with application-specific metrics
- **Create dashboards** - Build Grafana dashboards for your team
- **Set up alerts** - Configure alerting based on your SLOs
- **Integrate with existing monitoring** - Add to your Prometheus stack

## Resources

- [Prometheus Documentation](https://prometheus.io/docs/)
- [Grafana Dashboards](https://grafana.com/docs/)
- [PromQL Cheatsheet](https://promlabs.com/promql-cheat-sheet/)
